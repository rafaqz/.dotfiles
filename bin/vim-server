#!/bin/bash
#
# Opens files in an existing vim window, if there are multiple windows it will
# try and find the vim window that has a project for it (based on directories)
# used for in terminal vim using tmux for windows/panes

VIM_COUNT=`vim --serverlist | wc -l`
PROJECT_DIR=`pwd`
SERVER_NAME=`date +%s`
echo "Vim instances: $VIM_COUNT"

# No arguments were passed in, assume its a "project" and give it a server
# "name" and set a project_dir in vim
if [[ "$1" == "" ]]; then
  /bin/vim -c "let project_dir='$PROJECT_DIR'" --servername "$SERVER_NAME"
  exit

# if [[ "$2" == "new" ]]; then
#   vim -c "let project_dir='$PROJECT_DIR'" --servername "$PROJECT_NAME" --remote-tab "$@"
#   exit

# There are no VIM servers running, open a new vim server with the file(s).
elif [ $VIM_COUNT -eq 0 ]; then
  /bin/vim -c "let project_dir='$PROJECT_DIR'" --servername "$SERVER_NAME" "$@"
  # urxvtr -e vim -c "let project_dir='$PROJECT_DIR'" ---servername "$PROJECT_NAME" --remote-tab "$@"
  exit


# There is one VIM server, open the file in that server and focus vim (via tmux).
elif [ $VIM_COUNT -eq 1 ]; then
  SERVER_NAME=`vim --serverlist | grep .`
  /bin/vim --servername "$SERVER_NAME" --remote-tab "$@"
  exit

# There are more than one VIM servers running, choose the appropriate one by
# finding its project root directory
elif [ $VIM_COUNT -gt 1 ]; then
  # And try and get all the files passed in
  args=("$@")
  for ((i=0; i < $#; i++)) {
    file=${args[$i]}
    bro=`readlink -f "$file"`
    files="$files$bro\n"
  }

  server_to_use=""
  last_match_count_winner="0"

  # Go through all of the vim servers
  /bin/vim --serverlist | { while read -r servername; do
    # Find the "project" directory" of the server in question
    project_dir=`vim --servername "$servername" --remote-expr 'getcwd()'`
    # See if the project directory matches any of the files
    matched=`echo "$files" | grep -o "$project_dir"`
    # count the length of the match
    matched_count=`echo -e $matched | wc -c`
    # try and find the project that is nearest the file matched
    if [[ $matched_count -gt $last_match_count_winner ]]; then
      server_to_use="$servername"
      last_match_count_winner="$matched_count"
    fi
    done

    # once we have the vim server that is the "project" for the file, open the
    # file in that vim server and focus the tmux tab.
    if [[ "$server_to_use" != "" ]]; then
      SERVER_NAME=$server_to_use
      /bin/vim --servername "$SERVER_NAME" --remote-tab "$@"
    fi

  }

fi
